\documentclass{oc}

%% Glossary Definition
\makeglossaries

\newglossaryentry{program}
{
  name=program,
  description={Package containing executable bytecode or source code published through vetted catalogues}
}

\newglossaryentry{program-id}
{
  name={program content identifier},
  description={Content-addressable location where the \gls*{program} package can be retrieved; e.g., an IPFS CID}
}

\newglossaryentry{agent}
{
  name=agent,
  description={A program instance running on a \gls*{provider}}
}

\newglossaryentry{consumer}
{
  name=consumer,
  description={Party that leases the hosting of an \gls*{agent} on a \gls*{provider} within the network}
}

\newglossaryentry{provider}
{
  name=provider,
  description={Node responsible for negotiating service agreements, hosting \glspl*{agent} according to active leases, and receiving leasing fees.}
}

\newglossaryentry{auditor}
{
  name=auditor,
  description={Node responsible for verifying the execution of \glspl*{agent} involved in active leases and providing attestations to authorize the payment of leasing fees.}
}

\newacronym{pcid}{PCID}{The Program Content Identifier}

%% Watermark
% \usepackage{draftwatermark}


%% Document
\begin{document}

\title{Ocelloids Network Specification}
\author{The Zone Council, SO/DA}
\date{\today}
\maketitle

\begin{abstract}
This document outlines the functional specifications of the Ocelloids network, a system for secure and transparent leasing of software agents that observe, correlate, and respond to blockchain activity.
The network comprises provider nodes hosting agents under negotiated leases with consumers.
A continuous service attestation process ensures reliable agent operation, while the network registry controls the admission and revocation processes for service providers and auditors within a trust zone.
The document details network roles, leasing processes, and attestation methods, providing a comprehensive understanding of the Ocelloids network's functionalities.
\end{abstract}

%% Table of contents
%%\newpage
%%\tableofcontents

%% Sections
\newpage

\section{Introduction}\label{sec:introduction}

The Ocelloids network operates as a real-time reactive layer with software \glspl*{agent} that observe, correlate, and respond to blockchain activity.
These \gls*{program} instances, hosted by \gls*{provider} nodes in a leasing model, naturally connect offchain data with onchain activity.
\Glspl*{provider} undergo an admission process within a trust zone and operate within defined geographical boundaries, subject to applicable laws.
The \nameref{sec:service-attestation} process ensures the reliable functioning of the \glspl*{agent}, enabling \glspl*{provider} to earn leasing fees for hosting them.

\section{Network}

An Ocelloids network is a collection of nodes under a common trust zone with vetted access for participation.

The network is governed through an onchain registry, known as the \nameref{sec:network-registry}, containing participant information and their \nameref{sec:network-roles}.

Network participants have well-known identities tied to specific organizations, geolocations, and publicly accessible endpoints.

\subsection{Network Registry}\label{sec:network-registry}

The network registry defines a trust zone characterized by designated sovereign and administrative accounts. Each of these accounts is endowed with privileges related to the admission and revocation of service providers and auditors.
These procedures play a critical role as they establish connections with entities subject to liabilities and potentially involve the establishment of legally binding contractual agreements.

Each participant of the network has an associated \nameref{table:party-record}, which includes essential information for locating service providers and verifying the authenticity of digital signatures.

\begin{xltabular}{\linewidth}{ l  X }
  \caption{Party Record} 
  \label{table:party-record}\\
  \toprule
   Property & Description  \\
  \midrule
  \endfirsthead
   Property & Description  \\
  \midrule
  \endhead
  \bottomrule
  \endfoot
  
  Subject &  Distinguished name\cite{x510}. \\ \addlinespace

  Accounts & Operator and treasurer blockchain account addresses. \\ \addlinespace
    
  Endpoints & URLs\cite{rfc3986} of the public endpoints. \\  \addlinespace
  
  Location & Geographic point location\cite{iso6709}. \\  \addlinespace
    
  Role & The node role (section \ref{sec:network-roles}). \\ \addlinespace
  
\end{xltabular}

\subsection{Network Roles}\label{sec:network-roles}

The network encompasses two node roles:
\begin{description}
  \item[\emph{\Gls*{provider} Node}] Negotiates service agreements, hosts \glspl{agent} in accordance with active leases and receives leasing fees.
  \item[\emph{\Gls*{auditor} Node}] Verifies the execution of the \glspl{agent} involved in active leases and provides attestations to authorize the payment of leasing fees.
\end{description}

\section{Service Leasing}\label{sec:leasing}

The service leasing process involves consumers requesting service offers, depositing funds onto the blockchain for \gls{agent} execution, undergoing continuous service attestations, managing periodic payment claims, and facilitating automatic lease renewals.

\subsection{Service Agreement}\label{sec:service-agreement}

The service agreement process mandates that the \gls{consumer} deposit funds to cover at least one period before the \gls{provider} provisions the \gls{agent}.
The high-level steps are as follows:

\begin{enumerate}
  \item \emph{Request Quote}. The \gls{consumer} initiates the leasing process by submitting a quote request to the \gls{provider}, specifying the desired \gls{program-id} for execution.
  
  \item \emph{Service Offer}. The \gls{provider} responds with a service offer, providing details such as the \gls{program-id} to be executed, the leasing period duration in number of blocks, leasing fee, and minimum deposit required.
  
  \item \emph{Place Deposit}. The \gls{consumer} submits a deposit to the blockchain, specifying the offer and the transfer amount. The funds for one leasing period are locked, with any remaining funds available for withdrawal by the consumer at any time.
  
  \item \emph{Confirm Deposit}. The blockchain issues a deposit receipt for the offer to the \gls{consumer}, confirming the deposit. The \gls{consumer} then sends this receipt to the \gls{provider}.
  
  \item \emph{Provision Agent}. The \gls{provider} verifies the deposit and provisions the \gls{agent} based on the accepted offer.
  
  \item \emph{Confirm Lease}. The \gls{provider} submits the deposit receipt to the blockchain to formalize the lease, receiving a lease receipt in response.
  
  \item \emph{Activate Lease}. The \gls{provider} acknowledges the lease activation to the \gls{consumer} upon receiving the lease receipt.
\end{enumerate}

\subsection{Service Attestation}\label{sec:service-attestation}

The service attestation process\footnote{
  For non-deterministic sources affecting the program output, a snapshot mechanism must be provided for reproducibility.
} involves \glspl{auditor} continuously verifying the accurate operation and fulfillment of the agents hosted by a \glspl{provider} under the leasing duration.
The attestation process operates within the timeframe of a leasing period.
During the period, the provider commits a verifiable proof of the processing of each block.
Since the blocks could be processed out of order, the \gls{provider} maintains a local verifiable key-value map independent of the insertion order, such as a sparse Merkle tree\cite{cryptoeprint:2016/683}.
The commitment to the map adds a pair $(k, v)$, where $k=Block_{hash}$ and $v=\text{digest}(Program_{output})$.
The \gls{provider} must anchor the top hash of the verifiable map at the end of the period.
The attestation process for each period works as follows:

\begin{enumerate}
  \item \emph{Request Service Proofs}. The \gls{auditor} requests service proofs for a random sample\footnote{
    A simple approach would be to use Yamane's method ($n=\frac{N}{1+Ne^2}$) for $N$ blocks in the period, where $n\approx400$ for a 1-month period.
  } of block hashes within the most recent anchored period. $B_{samp}=\{Block_{hash}^0,\ldots,Block_{hash}^n\}$.
  
  \item \emph{Present Service Proofs}. The \gls{provider} presents the requested inclusion proofs for the given block hashes. $P_{samp}=\{Proof(b) : b \in B_{samp}\}$,
  where $Proof$ produces an inclusion proof for the commited value $v$ on the key $b$.
  
  \item \emph{Verify Service Proofs}. The \gls{auditor} verifies the inclusion proofs $P_{samp}$.
    \begin{enumerate}
      \item Confirms the inclusion proof using the anchored top hash for the period.
      \item Independently processes the selected blocks to verify that the digest of the resulting log output matches the value $v$ of the requested block in the proof.
    \end{enumerate}
  \item
    \begin{enumerate}[(i)]
      \item \textbf{On successful verification} \\
      \emph{Record Attestation}. The \gls{auditor} submits a signed attestation of the verified period. The attestation authorizes\footnote{
        Variations could require signatures from multiple auditors.
      } the payment of leasing fees\footnote{
        The authorized payment should be captured by the \gls{provider} and could entail the deducation of a managment fee accrued to the \gls{auditor}/s.
      } by the \gls{provider}.
      \item \textbf{Otherwise} \\
      \emph{Record Dispute}. The \gls{auditor} submits a signed dispute with details for further resolution\footnote{
        While operating in a vetted governance model (i.e., without funds at stake),
        the resolution falls under the discretion of the trust zone sovereign entities,
        who are responsible for revoking the misbehaving party and transferring funds to the rightful party.
      }.
    \end{enumerate}

\end{enumerate}

This continuous attestation process ensures the maintenance of verified operational records, serving as a prerequisite for claiming leasing fees.

\subsection{Claim \textit{\&} Renewal}\label{sec:claim-renewal}

At the end of each leasing period, the \gls{provider} must claim the leasing fees and an automatic renewal process is initiated.
\begin{enumerate}
    \item \emph{Claim Fees}. \Gls{provider} claims the payment of the fees for the leasing period by submitting a transaction to the blockchain; e.g., \textit{ClaimPaymentForPeriod}.
    \item \emph{Verify \& Transfer}. Blockchain verifies the latest \gls{agent} operational attestation and transfers the funds to the \gls{provider}.
    \item \emph{Renewal Check}. \Gls{provider} checks renewal conditions:
      \begin{enumerate}
        \item The lease is active.
        \item Enough funds for next period in the \gls{consumer} account.
      \end{enumerate}
    \item
      \begin{enumerate}[(i)]
        \item \textbf{On successful check} \\
          \emph{Renew Lease}. Blockchain initiates the renewal process, locking funds for the next period.
        \item \textbf{Otherwise} \\
          \emph{Cancel Lease}. Blockchain cancels the lease, and the \gls{provider} takes appropriate actions to decommission the \gls{agent}.
      \end{enumerate}
\end{enumerate}

This process ensures a smooth transition between leasing periods, with automatic renewals and the flexibility to cancel if necessary.
Consumers are responsible for maintaining sufficient deposit funds to cover renewals.

\clearpage

\printglossary

\bibliography{std.bib}

\end{document}
